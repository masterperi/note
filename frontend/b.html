<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Browse Stored PDFs | BlinkNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700,800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="pdfBrowseRedesign.css" />

  <style>
    /* ===== Root Variables ===== */
    :root {
      --main-bg: #d9d9d9;
      --card-bg: #fff;
      --btn-bg: #000;
      --btn-radius: 12px;
      --input-radius: 12px;
      --input-bg: #fff;
      --input-border: #DFDFDF;
      --divider: #444;
    }

    /* ===== Base Styles ===== */
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--main-bg);
      color: #222;
      margin: 0;
    }

    /* ===== Buttons ===== */
    .btn-outline, .btn-primary, .btn-link, .btn-success {
      border: none;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      padding: 8px 15px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      text-decoration: none;
      transition: all 0.13s ease-in-out;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .btn-outline {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-outline:hover {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-link {
      background: none;
      color: var(--accent);
      box-shadow: none;
    }
    .btn-success {
      background: #31c48d;
      color: #fff;
    }
    .btn-success:hover {
      background: #27ab78;
    }
    .back-btn {
      margin-top: 32px;
    }

    /* ===== Container ===== */
    .browse-container {
      max-width: 950px;
      margin: 42px auto 0 auto;
      padding-bottom: 70px;
    }
    .section-title {
      font-size: 1.48em;
      font-weight: 700;
      margin: 38px 0 15px 0;
    }

    /* ===== Search Box ===== */
    .pdf-search-box {
      background: #fff;
      border-radius: var(--radius);
      padding: 21px 21px 17px 21px;
      box-shadow: var(--shadow);
      margin-bottom: 32px;
      display: flex;
      flex-direction: column;
      gap: 11px;
      max-width: 480px;
    }
    .pdf-search-box label {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .pdf-input-row {
      display: flex;
      gap: 10px;
    }
    .pdf-input-row input[type="text"] {
      flex: 2;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 9px 14px;
      font-size: 15px;
    }
    .pdf-input-row .btn-success {
      flex: 1;
      padding: 9px 0;
    }

    /* ===== PDF Cards Grid ===== */
    .pdf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 28px;
      margin-bottom: 40px;
    }
    .pdf-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 14px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      min-height: 320px;
      transition: transform 0.15s ease;
    }
    .pdf-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.07);
    }
    .pdf-metadata {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }
    .pdf-title {
      font-weight: 600;
      font-size: 1.08em;
      color: #222;
    }
    .pdf-id-pill {
      background: #eef0ff;
      color: var(--accent);
      padding: 3px 9px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    .pdf-frame {
      width: 100%;
      border: none;
      min-height: 200px;
      border-radius: 8px;
      background: #f3f4f8;
      margin-top: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .error-msg {
      color: red;
      font-weight: 600;
      margin-top: 12px;
    }

    /* ===== Responsive ===== */
    @media (max-width:700px) {
      .browse-container { padding: 0 10px; }
      .pdf-grid { grid-template-columns: 1fr; }
      .pdf-card { min-height: 220px; }
      .pdf-search-box { max-width: 100%; }
      .section-title { font-size: 1.11em; }
    }

    /* ===== New Simple Chatbot Styles ===== */
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--main-bg-dark);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      font-size: 24px;
      transition: transform 0.3s ease;
      z-index: 999;
    }
    .chat-toggle:hover { transform: scale(1.1); }
    .chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 250px;
      height: 300px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: popUp 0.3s ease;
      z-index: 1000;
    }
    @keyframes popUp {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .header {
      background: #444;
      color: white;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }
    .beta-badge {
      background: rgba(255,255,255,0.2);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 10px;
    }
    .clear-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    .chat-body {
      flex: 1;
      padding: 6px;
      overflow-y: auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    .bubble {
      padding: 5px 8px;
      border-radius: 8px;
      margin: 4px 0;
      max-width: 90%;
    }
    .bubble.user {
      background: #DCF8C6;
      align-self: flex-end;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .bubble.bot {
      background: #F1F0F0;
      align-self: flex-start;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .chat-input-area {
      display: flex;
      border-top: 1px solid #ddd;
    }
    .chat-input {
      flex: 1;
      padding: 5px;
      border: none;
      font-size: 12px;
    }
    .send-btn {
      background: var(--btn-bg);
      border: none;
      padding: 0 10px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- ===== Navbar ===== -->


<!-- ===== Main Content ===== -->
<main class="browse-container">
  <h2 class="section-title">ðŸ“‚ Display Stored PDF</h2>
  <section class="pdf-search-box">
    <label for="docId">Enter Document ID</label>
    <div class="pdf-input-row">
      <input type="text" id="docId" placeholder="Enter Document ID (e.g., aabbcc123)" />
      <button class="btn btn-success" onclick="loadPDF()"><i class="fas fa-search"></i> Load PDF</button>
    </div>
    <iframe id="pdfViewer" class="pdf-frame" hidden></iframe>
  </section>

  <h2 class="section-title">ðŸ“š All Stored PDFs</h2>
  <section class="pdf-grid" id="pdfContainer"></section>

  <a href="upload.html" class="btn btn-primary back-btn"><i class="fas fa-arrow-left"></i> Back to Upload</a>
</main>

<!-- ===== Chatbot ===== -->
<div class="chat-toggle" id="chatToggle"><i class="fa-solid fa-robot"></i></div>
<div class="chat-container" id="chatContainer">
  <div class="header">
    <span class="logo">BlinkNotes</span>
    <span class="beta-badge">Beta</span>
    <button class="clear-btn" title="Clear Chat">âœ–</button>
  </div>
  <div class="chat-body" id="chatBody">
    <div class="bubble bot">Hi, how can I help you?</div>
  </div>
  <form class="chat-input-area" id="chatForm">
    <input type="text" class="chat-input" placeholder="Typeâ€¦" autocomplete="off" id="chatInput"/>
    <button class="send-btn" type="submit">âž¤</button>
  </form>
</div>

<!-- ===== Scripts ===== -->
<script src="config.js"></script>
<script>
  const toggleBtn = document.getElementById('chatToggle');
  const chatBox = document.getElementById('chatContainer');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('chatInput');
  const chatBody = document.getElementById('chatBody');

  toggleBtn.onclick = () => {
    chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex';
  };
  form.onsubmit = async function(e) {
    e.preventDefault();
    const msg = input.value.trim();
    if (!msg) return;
    addMessage(msg, 'user');
    input.value = '';
    await getBotResponse(msg);
  };
  function addMessage(msg, type) {
    const div = document.createElement('div');
    div.className = "bubble " + type;
    div.textContent = msg;
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  async function getBotResponse(userInput) {
    addMessage("Typing...", 'bot');
    try {
      const response = await fetch(`${window.env.API_URL}/chat/gpt`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userInput })
      });
      const data = await response.json();
      document.querySelector('.bubble.bot:last-child').remove();
      addMessage(data.reply.trim(), 'bot');
    } catch (err) {
      document.querySelector('.bubble.bot:last-child').remove();
      addMessage("Error: Could not connect to AI.", 'bot');
    }
  }
  document.querySelector('.clear-btn').onclick = function() {
    chatBody.innerHTML = '';
  };

  async function loadPDF() {
    const docId = document.getElementById('docId').value.trim();
    const viewer = document.getElementById('pdfViewer');
    if (!docId) {
      alert("Please enter a document ID");
      viewer.hidden = true;
      return;
    }
    try {
      const response = await fetch(`http://localhost:3000/file/${docId}`);
      if (!response.ok) throw new Error('File not found');
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      viewer.src = url;
      viewer.hidden = false;
    } catch (error) {
      alert("Error loading PDF: " + error.message);
      viewer.hidden = true;
    }
  }
  async function loadAllPDFs() {
    const container = document.getElementById('pdfContainer');
    container.innerHTML = '<p>Loading...</p>';
    try {
      const listResponse = await fetch('http://localhost:3000/files');
      const files = await listResponse.json();
      if (files.length === 0) {
        container.innerHTML = '<p>No PDFs found.</p>';
        return;
      }
      container.innerHTML = '';
      files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'pdf-card';
        card.innerHTML = `
          <div class="pdf-metadata">
            <span class="pdf-title"><i class="fa-solid fa-file-pdf"></i> ${file.fileName}</span>
            <span class="pdf-id-pill">${file.id}</span>
          </div>
          <iframe src="http://localhost:3000/file/${file.id}" class="pdf-frame"></iframe>
        `;
        container.appendChild(card);
      });
    } catch (err) {
      container.innerHTML = `<p class="error-msg">Error loading PDFs: ${err.message}</p>`;
    }
  }
  window.onload = loadAllPDFs;
</script>
</body>
</html>
